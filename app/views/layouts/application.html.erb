<!DOCTYPE html>
<html>
  <head>

    <title>Yum List</title>
    <meta name="description" content="Organize your favorite restaurants!">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="<%= theme_color_for_page %>">
    <meta name="msapplication-TileColor" content="#B1454A">
    <meta name="msapplication-square70x70logo" content="<%= image_path('yum-list-new-logo.jpg') %>">
    <meta name="msapplication-square150x150logo" content="<%= image_path('yum-list-new-logo.jpg') %>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Encode+Sans:wght@100..900&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="<%= image_path('yum-list-new-logo.jpg') %>">
    <link rel="icon" type="image/png" sizes="32x32" href="<%= image_path('favicon.ico') %>">
    <link rel="icon" type="image/png" sizes="16x16" href="<%= image_path('favicon.ico') %>">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <!-- Enregistrement pr√©coce du Service Worker -->
    <script>
        // Enregistrer le Service Worker d√®s que possible (avant le chargement de la page)
        (function() {
            if (!('serviceWorker' in navigator)) {
                console.warn('‚ö†Ô∏è Service Worker non support√© dans ce navigateur');
                return;
            }

            // V√©rifier d'abord si le service worker est accessible
            fetch('/service-worker.js', { method: 'HEAD' })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Service Worker non accessible: ' + response.status);
                    }
                    console.log('‚úÖ Service Worker fichier accessible');
                    
                    // Enregistrer le service worker
                    return navigator.serviceWorker.register('/service-worker.js', {
                        scope: '/'
                    });
                })
                .then(function(registration) {
                    console.log('‚úÖ ServiceWorker enregistr√© avec succ√®s, scope:', registration.scope);
                    console.log('üìã √âtat du Service Worker:', registration.active ? 'actif' : 'en attente');
                    
                    // V√©rifier l'√©tat du service worker
                    if (registration.installing) {
                        console.log('‚è≥ Service Worker en cours d\'installation...');
                        registration.installing.addEventListener('statechange', function() {
                            console.log('üìã √âtat change:', this.state);
                            if (this.state === 'activated') {
                                console.log('‚úÖ Service Worker activ√©!');
                            }
                        });
                    } else if (registration.waiting) {
                        console.log('‚è≥ Service Worker en attente...');
                    } else if (registration.active) {
                        console.log('‚úÖ Service Worker d√©j√† actif!');
                    }
                    
                    // V√©rifier s'il y a des mises √† jour
                    registration.addEventListener('updatefound', function() {
                        const newWorker = registration.installing;
                        console.log('üîÑ Nouveau Service Worker trouv√©, installation...');
                        newWorker.addEventListener('statechange', function() {
                            console.log('üìã Nouveau SW √©tat:', this.state);
                            if (this.state === 'activated') {
                                console.log('‚úÖ Nouveau Service Worker activ√©!');
                            }
                        });
                    });
                    
                    // Marquer le service worker comme disponible globalement
                    window.serviceWorkerReady = registration.ready || Promise.resolve(registration);
                })
                .catch(function(err) {
                    console.error('‚ùå Erreur lors de l\'enregistrement du ServiceWorker:', err);
                    console.error('üìã D√©tails:', err.message, err.stack);
                    window.serviceWorkerError = err;
                });
        })();
    </script>
    
    <%= javascript_importmap_tags %>
    <%= stylesheet_link_tag "tailwind", "inter-font", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markerclustererplus/2.1.4/markerclusterer.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_PLACES_API_KEY'] %>&libraries=places,marker"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body>
    <%= render "shared/flashes" %>

    <%= render "shared/navbar" %>

    <%= yield %>

    <!-- prettier-ignore -->

  </body>
</html>
